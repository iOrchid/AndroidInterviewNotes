---

		title:  深入探索 Android 网络优化（一、网络筑基篇）
		date: 2020/2/5 17:43:00   
		tags: 
		- Android进阶
		categories: Android进阶
		thumbnail: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1557665970516&di=b58d306a0db07efca58f8c9b655f5c13&imgtype=0&src=http%3A%2F%2Fimg02.tooopen.com%2Fimages%2F20160520%2Ftooopen_sl_055418231108.jpg
---

---

# 前言

### 成为一名优秀的Android开发，需要一份完备的[知识体系](https://github.com/JsonChao/Awesome-Android-Exercise)，在这里，让我们一起成长为自己所想的那样~。


网络优化一直被认为是移动优化水最深的领域之一，因此要想对网络进行深入优化，我们就必须先打下比较扎实的网络基础，在本文中，我们将再次重温计算机网络中的重点知识，以此在脑海中建立一个较为全面的网络基础知识体系。


## 大纲


![](https://user-gold-cdn.xitu.io/2020/5/13/1720b5afbc0b40a3?w=3148&h=3016&f=png&s=1204803)


# 一、重识计算机网络

## 1、计算机网络是什么？

- 1）、主要由 **通用、可编程的硬件互连** 而成。
- 2）、通过这些硬件，可以 **传送不同类型的数据**。
- 3）、计算机网络不仅包含 **软件概念**，还包含 **硬件设备**。
- 4）、计算机网络不仅仅是 **信息通信**，还可以 **支持广泛和日益增长的应用**。


## 2、计算机网络的分类

### 1）、按作用范围

#### 广域网（WAN）

几十 KM ~ 几千 KM，跨省、跨国。

#### 城域网（MAN）

5 KM ~ 50 KM，城市间、城市内。

#### 局域网（LAN）

1 KM 内，地区内、家庭间、公司内。


### 2）、按网络使用者

#### 公用网络

所有可以通过付费方式就可以加入的网络。

#### 专用网络

某些部队、组织或者某些人 **为了满足特殊业务需求而建立起来的特殊的网络**，例如军队、铁路、银行都有自己的专用网络。


# 二、网络历史演进

## 1、世界互联网发展历史演进

### 1）、单个网络

**ARPANET**，1969年美国国防部创建的一个网络，可以连接周围的计算机。

计算机直接通过交换机就可以进行信息交换。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4ef50b60e990?w=1592&h=712&f=png&s=112371)


### 2）、三级结构

**现代互联网的雏形**，也称为 **互联网络**，可以把美国所有的大学、研究所、实验室都连接起来。

从上至下，由 **主干网、地区网、校园网** 组成。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f06d452539c?w=2068&h=834&f=png&s=350338)


### 3）、多层次 ISP

`ISP(Internet Service Provider)`：网络服务提供商，例如中国电信、中国移动、中国联通等。**从上之下，由主干 ISP、地区 ISP 组成**。

#### 主干 ISP

中国的主干 ISP 包括 **中国电信、中国移动、中国联通**，它们可以连接美国和其它国家的主干 ISP。

#### 地区 ISP

例如移动网络，在北京叫 **北京移动**，在上海叫 **上海移动**，这些就属于地区 ISP。**地区 ISP 可以连接公司、校园、家庭的网络**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f0c33f8a4ba?w=2106&h=850&f=png&s=444054)


### 4）、了解现代国际互联网的主要线路

我们可以通过 [infrapedia](https://live.infrapedia.com) 网站了解国际互联网的主要线路。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f1c0019a551?w=2322&h=1076&f=png&s=1942203)


上图刻画了 **全球的所有主干网络的线路**，可以看到，**中国的主干网络出口基本都是位于广东、福建等沿海地区，它们通过各自的海底电缆与位处于世界各地的主干网络相互连接，最终形成了互联网**。


## 2、中国互联网发展历史

### 1）、1980 年

中国铁道部开始互联网实验。

### 2）、1989 年

建立并运行第一个公共网络。

### 3）、1994 年

接入国际互联网。

### 4）、至今

**当今中国最大的五个公用的计算机网络**：

- **中国电信互联网(CHINANET)**
- **中国联通互联网(UNINET)**
- **中国移动互联网(CMNET)**
- **中国教育与科研计算机网(CERNET)**
- **中国科学技术网(CSTNET)**


## 3、中国的互联网企业

- 1996年，张朝阳创建搜狐。
- 1997年，丁磊创建网易。
- 1998年，王志东创建新浪，马化腾、张志东创建腾讯。
- 1999年，马云创建阿里巴巴。
- 2000年，李彦宏创建百度。


# 三、重识网络层次结构

### 网络为什么要分层？

因为复杂的程序都要分层。这是一个架构设计的通用问题，不仅仅是网络协议的问题，**只要涉及复杂的逻辑或软件需求需要经常变动的情况通常都会通过分层来解决**。


### 思考🤔：设计一个计算机网络需要解决哪些问题？

- 1）、传输数据时需要保证数据通路顺畅。
- 2）、需要识别目的计算机。
- 3）、需要了解目的计算机的状态。
- 4）、数据是否错误。


总之，计算机网络需要解决的问题是繁多而复杂的，所以我们需要 **采用分层的设计分别去解决不同的问题，实现不同的功能**。


## 1、层级结构设计的基本原则

### 1）、相互独立

每一层仅仅实现一个相对独立的功能，并且需要确保层与层之间的耦合度是非常低的。

### 2）、灵活性

每一层的设计需要具备很好的灵活性、扩展性，以适应未来的网络变化。

### 3）、耦合度

各层之间是完全解耦的，层与层之间的变化互不影响。


## 2、OSI 七层模型

OSI | 功能
---|---
应用层 | 为计算机用户提供接口和服务。
表示层 | 数据处理：编解码、加解密等等。
会话层 | 管理（建立、维护、重连）通信会话。
传输层 | 管理端到端的通信连接。
网络层 | 数据路由：决定数据在网络中的路径。
数据链路层 | 管理相邻节点之间的数据通信。
物理层 | 数据通信的光电物理特性。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f2223f673e1?w=2066&h=948&f=png&s=858246)


### 1）、OSI 悲催的故事

- 1）、一开始，OSI 欲称为全球计算机都遵守的标准。
- 2）、但是，OSI 在市场化的过程中困难重重，因为 TCP/IP 已经在全球范围成功运行。
- 3）、最终，OSI 并没有称为广为使用的标准模型。


### 2）、OSI 七层模型失败的原因

- 1）、OSI 的专家没有充分将理论与实际进行结合。
- 2）、OSI 标准的制定周期过长，按 OSI 标准生产的设备无法及时进入市场。
- 3）、OSI 模型的设计不合理，某些功能在多层重复出现。


## 3、TCP/IP 四层模型


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f27cbafc12f?w=2070&h=928&f=png&s=578708)


我们需要理解数据通信过程中不同设备之间协议的转换。从下图可以看到 **路由器仅包括网络层与网络接口层**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f334671bf39?w=2044&h=904&f=png&s=441450)


从协议的数量来看，TCP/IP 四层模型构成了中间窄，两端大的⏳沙漏形状。如下图所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f35e1e157bc?w=2208&h=700&f=png&s=364376)


# 四、初识现代网络拓扑

## 1、为什么要了解网络拓扑？

因为它 **有助于我们在脑海里面形成一个形象的计算机网络**。

## 2、网络拓扑分类

### 1）、边缘部分

#### 家庭

由 **终端机器、路由器、网关、地区 ISP** 组成。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f3a5a49bcfe?w=2056&h=780&f=png&s=165846)


#### 企业

不同于家庭的网络拓扑，其 **网关细分为内部网关与统一网关**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f3e31828128?w=2200&h=810&f=png&s=237249)


### 2）、核心部分

由 **地区 ISP、主干 ISP、路由器、海底电缆或跨地区电缆** 组成。其中的 **通信设备（一般是华为）主要是由移动、联通所铺设的**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f40bf34946a?w=1914&h=846&f=png&s=248111)


现代互联网的网络拓扑形成了一个 **树状结构**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f42fa879e70?w=2112&h=808&f=png&s=456013)


### 3）、C/S 模式

由 客户端/服务端 模式组成，并可以相互进行通信。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f476817dd10?w=2004&h=902&f=png&s=243467)


### 4）、P2P 模式

不分为服务端和客户端，它们都是 **对等地进行连接的**，优势在于可以使 **下载速度更快**，如迅雷下载器中就应用了这种模式。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f4b5c0fcffb?w=2130&h=910&f=png&s=259181)


# 五、网络性能指标

## 1、速率

```
即 bps <==> bit/s
```

网络数据传输的各种单位与之对应的常见设备


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f51d1127ae4?w=2204&h=400&f=png&s=372434)


### 为什么电信拉的 100M 光纤，测试峰值速度只有 12M 每秒？

网络常用单位为（Mbps），因此这里的 100M 指的是 100Mbps。

```java
100 M/S = 100 Mbps = 100 Mbit/s
100 Mbit/s = （100/8）MB/s = 12.5 MB/s
```


## 2、时延
 
### 1）、发送时延

```java
发送时延 = 数据长度（bit）/ 发送速率（bit/s）
```


数据长度是由用户决定的，而发送速率是由计算机网卡所决定的。


### 2）、传输时延

```java
传播时延 = 传输路径距离 / 传播速率（bit/s）
```


传输路径距离是由用户决定的，而传播速率则受限于传输介质。


### 3）、排队时延

数据包在网络设备中等待被处理的时间，例如路由器需要一个一个处理完前面的数据包才能处理后面的。


### 4）、处理时延

数据包到达设备或者目的机器被处理所需的时间。


```java
总时延 = 发送时延 + 排队时延 + 传播时延 + 处理时延
```


## 3、往返时间 RTT（Route-Trip Time）

- 评估网络质量的一项重要指标。
- 表示数据报文在端到端通信中来回一次的时间。


### 通常使用 ping 命令查看 RTT

#### 1）、ping 查看当前城市中的 IP

```java
quchao@quchaodeMacBook-Pro ~ % ping 119.29.148.149
PING 119.29.148.149 (119.29.148.149): 56 data bytes
64 bytes from 119.29.148.149: icmp_seq=0 ttl=116 time=13.210 ms
64 bytes from 119.29.148.149: icmp_seq=1 ttl=116 time=19.118 ms
64 bytes from 119.29.148.149: icmp_seq=2 ttl=116 time=34.384 ms
```


#### 2）、ping 美国的 IP

```java
quchao@quchaodeMacBook-Pro ~ % ping 191.101.238.160
PING 191.101.238.160 (191.101.238.160): 56 data bytes
64 bytes from 191.101.238.160: icmp_seq=0 ttl=52 time=191.791 ms
64 bytes from 191.101.238.160: icmp_seq=1 ttl=52 time=180.278 ms
64 bytes from 191.101.238.160: icmp_seq=2 ttl=52 time=186.399 ms
```


# 六、应用层 

**传输层与之下的层已经提供了完整的通信服务**。而应用层是面向用户的一层。它主要是用来 **定义应用间通信的规则**，例如应用进程的报文类型（请求报文、应答报文）、报文的语法、格式、应用进程发送数据的时机、规则等等。


## 1、DNS(Domain Name System) 域名系统服务

域即对应的网络号，名即对应的主机名字。


### 1）、功能

通过把没有规则的点分十进制 IP 地址转换为可以理解的一些域名。


### 2）、域名

- 使用域名可以帮助记忆。
- 域名通过 DNS 服务可以被转换成 IP 地址。
- 域名是由点、字母和数字组成的。
- 点分割不同的域。
- **域名可以分为顶级域、二级域、三级域...，例如：www.taobao.com => - 三级域.二级域.顶级域**。


#### 顶级域常见分类

- 国家
    - cn
    - us
    - uk
    - ca
- 通用
    - com
    - net
    - gov
    - org


#### 二级域

例如：qq、aliyun、taobao、google、facebook 等等。

**顶级域、二级域、三级域组成了一个树状结构。且在顶级域名服务器上面还有一个根域名服务器**。


### 3）、域名服务器

只要有一个外网的服务器就可以搭建一个域名的服务器。


## 2、DHCP(Dynamic Host Configuratin Protocol) 动态主机设置协议

### 1）、是什么？

**网络管理员只需配置一段共享的 IP 地址，每一台新接入的机器都可以通过 DHCP 来这个共享的 IP 地址里面申请 IP 地址，就可以自动配置。等用完还回去其它机器也能使用**。它的特点如下所示：


- 1、**DHCP 是一个局域网协议**。
- 2、**DHCP 是应用 UDP 协议的应用层协议**。


### 2）、功能

- **即插即用联网**。
- **在 IP 配置界面选中 自动获得 IP 地址、自动获得 DNS 服务器地址即可启用 DHCP 协议去获取一个临时 IP（通常是一个内网地址）**。
- **有一个租期，在租期过半时可以续租**。


### 3）、DHCP 的过程

- 1）、**DHCP 服务器监听默认端口：67**。
- 2）、**主机使用 UDP 协议广播 DHCP 发现报文**。
- 3）、**DHCP 服务器发出 DHCP 提供报文**。
- 4）、**主机向 DHCP 服务器发出 DHCP 请求报文**。
- 5）、**DHCP 服务器回应并提供 IP 地址**。


### 4）、向 DHCP 租用的 IP 地址是有租期的，IP 地址如何实现续租呢？

客户端会在租期过去50%的时候，直接向为其提供 IP 地址的 DHCP 服务器发送 DHCP request 消息报。客户端接收到服务器回应的 DHCP ACK 消息包后，会根据消息报中提供的新的租期以及其他已经更新的 TCP/IP 参数更新自己的配置。


## 3、HTTP(HyperText Tranfsfer Protocol) 超文本传输协议

### 1）、是什么？

- HyperText 即超文本、超链接，Http 是指在电脑中显示的、**含有可以指向其他文本的链接文本**。
- 对于这些内容都有一个统一的路径，例如： `http(s)://<主机>:<端口>/<路径>`。
- **HTTP 协议底层是 TCP 协议，因此它是可靠的数据传输协议**。

### 2）、Web 服务器

分为硬件部分（计算机或云上的虚拟设备）和软件部分（Nginx、Apache)。

#### 过程

- 1）、**接受客户端连接**
- 2）、**接受请求报文**
- 3）、**处理请求**
- 4）、**访问 Web 资源**
- 5）、**构造应答**
- 6）、**发送应答**


### 3）、HTTP 请求方法


header 1 | header 2
---|---
GET | 获取指定的服务端资源。
POST| 提交数据到服务端。
DELETE | 删除指定的服务端资源。（很少用）
UPDATE | 更新指定的服务端资源。
PUT | 修改数据。
OPTIONS | 列出可对资源实行的请求方法，用来跨域请求。
CONNECT | 建立连接隧道，用于代理服务器
HEAD | 获取资源的元信息
TRACE | 追踪请求-响应的传输路径


#### GET 和 POST 的区别

- 1、**get参数通过url传递，post放在request body中**。
- 2、**get请求在url中传递的参数是有长度限制的，而post没有**。
- 3、**get比post更不安全，因为参数直接暴露在url中，所以不能用来传递敏感信息**。
- 4、**get请求只能进行url编码，而post支持多种编码方式**。
- 5、**get请求会浏览器主动cache，而post支持多种编码方式**。
- 6、**get请求参数会被完整保留在浏览历史记录里，而post中的参数不会被保留**。
- 7、**GET和POST本质上就是TCP链接，并无差别。但是由于HTTP的规定和浏览器/服务器的限制，导致他们在应用过程中体现出一些不同**。


### 4）、HTTP 指定资源

#### 1）、在地址中指定

> https://www.wanandroid.com/repo/100.html

repo/100.html 是指定的请求资源。

> https://www.wanandroid.com/?sort=0&unlearn=0&page=2

? 后面用来指定请求参数。

#### 2）、在请求数据中指定


### 5）、HTTP 请求报文

HTTP 的请求报文与响应报文都满足如下结构：

> 起始行 + 头部 + 空行 + 实体

其中的 **空行是用来区分开头部和实体的**。


HTTP 请求报文的格式如下所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f5994a7ad72?w=830&h=624&f=png&s=124439)


例如：

```java
POST https://www.wanandroid.com HTTP/1.1
Accept-Encoding:gzip
Accept-Language:zh-CN
...
{ 请求的 jsonString 内容}
```


### 6）、HTTP 应答报文


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f5bf97709b5?w=830&h=624&f=png&s=121283)


### 7）、HTTP 应答状态码



header 1 | header 2
---|---
100~199 | 协议处理的中间状态，还需要后续操作
200~299 | 成功
300~399 | 重定向
400~499 | 客户端错误
500~599 | 服务端错误


#### 100~199

- 101：Switching Protocols，服务器同意将 HTTP 升级为 WebSocket 时发送。


#### 200~299

- 200：在响应体中放有数据。
- 204：No Content，响应头后没有 body 数据。
- 206：Partial Content，通常用于 HTTP 分块下载和断点续传，同时带上相应的响应头字段 Content-Range。


#### 300~399

- 301：Moved Permanently，永久重定向。
- 302：Found，临时重定向。
- 304：Not Modified，协商缓存命中时返回。


#### 400~499

- 400：Bad Request，请求出错。
- 403：Forbidden，服务器禁止访问，原因有法律禁止、信息敏感等。
- 404：Not Found，资源未找到。
- 405：Method Not Allowed，请求方法不被允许。
- 406：Not Acceptable，资源无法满足条件。
- 408：Request Timeout，请求超时。
- 409：Conflict，多个请求发生了冲突。
- 413：Request Entity Too Large，请求体的数据过大。
- 414：Request-URI Too Long，请求行里的 URI 太大。
- 429：Too Many Request，客户端发送的请求过多。
- 431：Request Header Fields Too Large，请求头的字段内容太大。


#### 500~599

- 500：Internal Server Error，服务内部出错。
- 501：Not Implemented: 请求的功能不支持。
- 502：Bad Gateway: 服务器自身是正常的，只是数据通道有问题。
- 503：Service Unavailable: 服务器很忙，无法响应服务。


### 8）、HTTP 工作结构

#### Web 缓存

通常遵循 **二八原则**：一个网站的内容通常分为20%的热门内容，80%的冷门内容。因此可以优先缓存热门内容。

#### 存储器层次结构

缓存(CPU 高速缓存）/主存(内存)/辅存（磁盘）

#### Web 代理

- 通过 Web 代理可以屏蔽服务器的部署结构。
- 可以在 Web 代理里面设置规则，如防火墙来保证安全。

##### Web 代理的分类

- 1）、正向代理：代理客户端去访问 Server。
- 2）、反向代理：代理 Server 把数据返回给客户端。例如 Nginx、HAProxy 就是一些著名的代理软件。


#### CDN(Content Delivery Network)内容分发网络

- **用于将一些大的内容在临近的服务器留一个备份**。
- **使用 CDN 可以进行多媒体内容的加速**。


CDN的基本原理是 **广泛采用各种缓存服务器，将这些缓存服务器分布到用户访问相对集中的地区或网络中，在用户访问网站时，利用全局负载技术将用户的访问指向距离最近的工作正常的缓存服务器上，由缓存服务器直接响应**。


#### 爬虫

用于在互联网上采集信息， 例如百度、Google的本质就是一个爬虫，它们通过把整个网络的数据给取下来，并且做一个索引，然后把这些内容提供给大家，在进行搜索时就会匹配这些内容并返回。

##### 不好的爬虫的缺点:

- 增加网络拥塞。
- 损耗服务器资源。


## 4、HTTPS(Secure) 安全的 HTTP 协议

> https://<主机>:<443>/<路径>

HTTP 是明文传输的，但是我们需要在网络中传输 账号密码、个人信息、账号金额、交易信息、敏感信息，这会导致中间人非法截取信息，导致信息泄露。

### 1）、加密模型


- **对称加密：加密与解密都使用同一个秘钥**。
- **非对称加密：公钥加密，私钥解密，并且公钥与私钥是拥有一定数学关系的一组秘钥**。
    - **私钥：自己使用，不对外公开**。
    - **公钥：给大家使用，对外公开**。


### 2）、数字证书 签名校验

**数字证书是可信任组织颁发给特定对象的认证。而可信任组织即客户端与服务端都认为安全的组织**。

#### 数字证书格式

- 证书格式、版本号
- 证书序列号
- 签名算法
- 有效期
- 对象名称
- 对象公开秘钥


### 3）、SSL(Secure Sockets Layer)安全套接层

**SSL 位于传输层与应用层之间，它是一个子层，作用主要有两点**：

- 1）、**数据安全（保证数据不会被泄漏）与数据完整（保证数据不会被篡改）**。
- 2）、**对数据进行加密后传输**。


#### HTTPS 的通信过程

- 1）、**443 端口的 TCP 连接**。
- 2）、**SSL 安全参数握手**。
- 3）、**客户端发送数据**。
- 4）、**服务端发送数据**。


#### SSL(Secure Sockets Layer) 安全套接层握手过程

##### 1）、生成随机数 1、2、3 的过程


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f600911effc?w=2304&h=956&f=png&s=418175)


##### 2）、双端根据随机数 1、2、3 与相同的算法生成对称秘钥进行加密通信


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4ffdf2f1a7f6)


**HTTPS 综合地运用了对称加密与非对称加密，在进行随机数校验的阶段是使用了非对称加密来进行通信的，然后等双方都确定了三个随机数之后，就可以使用相同的算法来生成对称秘钥进行加密通信了。HTTPS 的优势在于双端分别生成了秘钥，没有经过传输，减少了秘钥泄漏的可能性**。


## 5、Http2

它的特点如下所示：

- 1）、**头部压缩**。
- 2）、**多路复用：多路复用允许同时通过单一的HTTP/2连接发送多重请求-响应信息。改善了：在http1.1中，浏览器客户端在同一时间，针对同一域名下的请求有一定数量限制（连接数量），超过限制会被阻塞**。
- 3）、**提升访问速度：相比 http1.1 请求资源所需时间更少，访问速度更快**。
- 4）、**二进制分帧：HTTP2.0 会将所有的传输信息分割为更小的信息或者帧，并对他们进行二进制编码**。
- 5）、**设置请求优先级**。
- 6）、**服务端推送**。


## 6、cookie

**HTTP 是一个无状态协议，因此 Cookie 的最大的作用就是存储 sessionId 用来唯一标识用户。并且，Cookie 本质上就是浏览器里面存储的一个很小的文本文件，内部以键值对的方式来存储**。


### 生存周期

通过 Expires 和 Max-Age 两个属性来设置：

- Expires：过期时间。
- Max-Age：表示一段时间间隔，单位是秒，从浏览器收到报文开始计算。


### 作用域

**我们可以使用 Domain 和 path 属性给 Cookie 绑定域名和路径。如果在发送请求之前，发现域名或者路径和这两个属性不匹配，那么就不会带上 Cookie**。需要注意的是，路径中含有 / 表示域名下的任意路径都允许使用 Cookie。


### 安全

- **带上 Secure：说明只能通过 HTTPS 传输 cookie**。
- **带上 HttpOnly：说明只能通过 HTTP 协议传输**。
- **带上 SameSite：预防 CSRF 攻击**。


### 缺点

- 1）、**安全缺陷：Cookie 很容易被非法用户截获，然后进行一系列的篡改，最后在 Cookie 的有效期内重新发送给服务器**。
- 2）、**容量缺陷：体积上限只有4KB，只能用来存储少量的信息**。
- 3）、**性能缺陷：Cookie 紧跟域名，因此域名下的请求都会携带上完整的 Cookie，这样随着请求数的增多，将会造成巨大的性能浪费，因为请求携带了很多不必要的内容。这里可以通过 Domain 和 Path 指定作用域去解决**。


## 7、HTTP 传输中的常见问题

- 1）、**跨域问题**
- 2）、**数据传输**
- 3）、**队头阻塞**


# 七、传输层

现在，当设备 A 与 设备 B 相互通信时，我们可以认为它们就是通过一个虚拟的互连网络进行连接的。**在虚拟的互连网络里面已经解决了网络拓扑、数据路由的走向等问题。在传输层重点解决的是两个设备它们直接是如何进行通信的**。

## 1、传输层的主要功能

### 1）、进程与进程的通信

不同于在单个操作系统内使用的进程间通信（Unix 域套接字、共享内存），网络通信可以跨设备、跨网络进行通信。

### 2）、端口的概念

- **使用端口来标记不同的网络进程**。
- **端口使用16比特位表示（0~65535）**。

常见的协议端口有：

协议 | 端口
---|---
FTP | 21 
HTTP | 80 
HTTPS | 443
DNS | 53
TELNET | 23


## 2、UDP(User Datagram Protocol)用户数据报协议


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f88108afc62?w=2040&h=926&f=png&s=479964)


### 1）、功能

UDP 协议 **不会对数据报进行任何的处理，即不合并，也不拆分数据**。

### 2）、特点

#### 1）、无连接

通信时并不需要提前建立连接。


#### 2）、不保证可靠的数据交付

想发就发，无法保证数据在网络传输过程中是否丢失。


#### 3）、面向报文传输

不对数据做任何处理，而是直接将应用层数据塞进报文里面。


#### 4）、没有拥塞控制

不管网络是否拥塞，它都会把数据给交付出去。


#### 5）、首部开销很小

首部仅仅占用8个字节。


### 3）、报文结构


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f8a2e5c838f?w=1596&h=624&f=png&s=168525)


- **UDP 长度最小值为 8， 即仅包括 UDP 首部**。
- **校验和是用来检测 UDP 的数据报在传输过程中是否出错**。


### 4）、基于 UDP 定制化的 5 个例子🌰

#### 1、来自网页或者 App 的访问

目前，HTTP 往往采取多个数据通道共享一个连接的策略，这样做本来是为了加快传输速度，但是 TCP 严格的顺序策略使得哪怕共享通道，前一个包不来，后一个包即使与前一个包没关系，也要等着，这样就会使时延加大。

而 QUIC（Quick UDP Internet Connection，快速 UDP 互联网连接）协议是 Google 提出的一种基于 UDP 改进的通信协议，其目的是降低网络通信的延迟，提供更好的用户互动体验。

QUIC 会在应用层上自己快速建立连接、减少重传时延、自适应拥塞控制，是应用层定制化的代表。

#### 2、流媒体协议

直播通常都使用 RTMP（Real Time Messaging Protocol，实时消息传输协议），基于 TCP。但对于直播来说实时性比较重要，宁可丢包，也不要卡顿。

对于视频播放来说，有的包可以丢，有的包不能，因为在视频的连续帧李，有的帧重要，有的不重要，如果一定要丢包，隔几个丢一个，其实看视频的人不会感知，但是如果是连续丢帧，就能感知到了，因此在网络不好的情况下，应用一般会选择性地丢帧。

当网络不好的时候，TCP 会主动降低发送速度，这对本来当时就卡的视频来讲无疑是雪上加霜。TCP 应该让应用层马上重传，而不是主动让步。因此，很多直播应用都基于 UDP 实现了自己的视频传输协议。

#### 3、实时游戏

维护 TCP 连接需要在内核维护一些数据结构，但是一台机器能够支撑的 TCP 连接数目是有限的。由于 UDP 是没有连接的，所以在异步 I/O 机制引入之前，UDP 常常是应对海量客户端连接的策略。

在游戏对实时要求比较严格的情况下，可以采用自定义的可靠 UDP 来传输数据包，通过使用自定义重传策略，能够包丢包产生的延迟降到最低，尽量减少网络问题对游戏造成的影响。

#### 4、物联网

Google 旗下的 Nest 建立了 Thread Group，推出了物联网通信协议 Thread，该协议就是基于 UDP 的。

#### 5、移动通信领域

在 4G 网络里，通过移动通信传输数据面对的协议 GTP-U 就是基于 UDP 的。关于移动网络的相关知识我们将在下一篇进行讲解。


## 3、TCP(Transmission Control Protocol) 传输控制协议初识

### 1、TCP 报文详解


![](https://user-gold-cdn.xitu.io/2020/5/12/17208321ff132ce3?w=1894&h=802&f=png&s=366404)


#### 1）、特点

- 1）、**面向连接：面向连接就像是打电话时需要先拨通电话**。
- 2）、**点对点通信**。
- 3）、**可靠的传输服务**。
- 4）、**全双工通信：两个设备在连接时，它们都可以同时地发送数据与接收数据**。
- 5）、**面向字节流的协议：TCP 处理的是一个一个的字节，所以TCP 很可能会取出数据中的某一段进行传输，而剩下的数据会把它放到第二个及之后的 TCP 报文中进行传输。因此 TCP 协议可能会对用户的数据进行合并或分拆**。


TCP 的缺点在于 **传输效率慢，因为它需要建立连接、发送确认包等等**。


#### 2）、报文首部字段


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f8fd9c58bec?w=1584&h=688&f=png&s=265898)


##### 序号

- 表示范围为 `0 ~ 2^32 - 1`。
- **因为 TCP 是面向字节流的，所以每一个字节都有一个与之对应的序号**。
- **TCP 数据报的序号就是数据报中第一个字节的序号**。


##### 确认号

- 表示范围为 `0 ~ 2^32 - 1`。
- **表示期望收到数据的首字节序号，如果确认号为 S，则表示 S - 1 序号的数据都已经收到了**。


##### 数据偏移

- **占4位：0 ~ 15，单位为：32位字。=> 首部范围为20~60字节**。
- **TCP 数据偏移首部的距离，因为 TCP 选项的大小是不确定的，所以需要此数据项**。


##### TCP 标记

**占6位**，每位都有不同的含义。

标记 | 含义
---|---
URG(Urgent) | 紧急位，URG = 1，表示紧急数据。
ACK(Acknowledgement | 确认位，ACK = 1，确认号才生效。
PSH(Push) | 推送位，PSH = 1，表示需要尽快地把数据交付给应用层。
RST(Reset) | 重置位，RST = 1，重新建立连接。
SYN(Synchronization) | 同步位，SYN = 1表示连接请求报文。
FIN(Finish) | 终止位，FIN = 1表示释放连接。


##### 窗口

- 占16位：`0 ~ 2 ^ 16 - 1`。
- **窗口指明允许对方发送的数据量。例如：确认号为201，窗口为300，那么可以接收序号的范围为 201 ~ 500**。


##### 校验和

与 UDP 类似，用来检测 TCP 的数据在传输过程中是否出错。

##### 紧急指针

- **紧急数据（URG = 1）**。
- **指定紧急数据在报文中的位置**。


##### TCP 选项

- **最多40字节**。
- **支持未来的扩展**。


## 4、可靠传输的基本原理

### 1）、停止等待协议

当发送方发送一个消息时，接收方接收到了并将确认信息发给发送方，这个过程中 **发送方需要停止等待接收方的确认信息**。

#### 超时重传

当消息发送出去后，发送方并没有在超时时间内接收到接收方的确认消息或者超时了之后消息才收到，此时会向发送方重新发送该消息。超时重传**通常都会处理三种异常情况**，如下所示：

- 1）、**发送的消息在路上丢失了**。
- 2）、**确认的消息在路上丢失了**。
- 3）、**确认的消息超时了才到**。


#### 超时定时器（超时重传定时器）

- 1）、**每发送一个消息，都需要设置一个超时定时器**。
- 2）、**主要应用在 TCP 的可靠传输协议里面，它是为了控制可能发生丢失的报文而设计的定时器，当 TCP 协议发送端发送一个报文时，就会为该报文设置一个超时定时器**。
- 3）、**如果超时定时器在结束之前收到了来自接收端对该报文段的确认，则撤销这个定时器**。
- 4）、**如果在超时定时器结束之前仍然没有收到来自接收端对该报文段的确认（超时），则认为这个报文可能已经丢弃，发送端会重新发送该报文，并设置一个超时定时器**。
- 5）、**需要注意的是，发送端在超时定时器撤销之前，必须继续缓存已发送未确认的报文，直到发送端收到了来自接收端的确认**。


#### 特点

- 1、**停止等待协议是最简单的可靠传输协议**。
- 2、**对信道的利用效率不高**。


> 既然单个发送和确认效率低，那么我们可以批量发送和确认吗？


### 2）、连续 ARQ(Automatic Repeat Request) 自动重传请求协议

ARQ 是对停止等待协议的改进，可以 **大幅提升信道利用率** 的一个协议。

#### 滑动窗口

- 1）、**窗口中的数据都可以发送**。
- 2）、**通过移动窗口的方式来标识没有接收到确认的消息**。
- 3）、**采用了累积确认的方式，并不需要对每一个消息都进行确认**。


#### 累积确认

只要我收到第5个消息的确认了，就表示第 1 ~ 5 个消息接收方都收到了。


## 5、TCP 协议的可靠传输

TCP 的可靠传输基于连续 ARQ 协议。

- 1）、**滑动窗口**
- 2）、**累积确认**
- 3）、**选择重传**


### 选择重传

- 1）、**选择重传需要制定需要重传的字节**。
- 2）、**每一个字节都有唯一的32位序号（4字节）**。
- 3）、**要重传的数据是存储在 TCP 选项 中，其中最多只能存储10个序号，即 5 个范围段的信息**。
- 4）、**选择重传的是一个信息边界，即一段字节流，例如：传送 1000 ~ 1200， 2000 ~ 3000 这个范围内的信息**。


## 6、TCP 协议的流量控制

流量控制指的是 **让发送方发送速率不要太快。TCP 使用了滑动窗口来实现流量控制**。


### 1）、滑动窗口

- rwnd = 300 ，表示窗口大小为300。
- 占16位：0 ~ 2 ^ 16 - 1。
- 窗口指明允许对方发送的数据量。例如：确认号为201，窗口为300，那么可以接收序号的范围为 201 ~ 500。
- **接收方可以调整滑动窗口的大小来控制发送方发送数据的效率**。
- **当接收方将 rwnd 从0调整为1000并将这个信息发送给发送方时，消息丢失了，这就会导致发送方和接收方都会等待，形成一个死锁局面**。


> 如何解决这种死锁局面呢？


### 2）、坚持定时器

坚持定时器是使用滑动窗口进行流量控制的时候设置的。

- 1）、**当接收到窗口为0的消息，则启动坚持定时器**。
- 2）、**坚持定时器每隔一段时间发送一个窗口探测报文**。


## 7、TCP 协议的拥塞控制

### 问题

- 一条数据链路经过非常多的设备。
- 数据链路中各个部分都有可能成为网络传输的瓶颈。


### 流量控制与拥塞控制的区别

**不同于流量控制考虑的是点对点的通信量的控制，拥塞控制考虑的是整个网络，是一个全局性的考虑**。


> 如何判断是否发生了拥塞？

**简单地认为报文超时就发生了拥塞**。


#### TCP 的拥塞控制

##### 1）、慢启动算法

- **由小到大逐渐增加发送数据量（呈指数增长，例如：1、2、4、8、16）**。
- **每收到一个报文确认，就加一**。
- **超过慢启动阈值(ssthresh) 则不再增长**。


##### 2）、拥塞避免算法

- **维护一个拥塞窗口的变量**。
- **只要网络不拥塞，就试探着将拥塞窗口调大**。


**TCP 的拥塞控制在前期使用了 慢启动 算法对窗口大小进行指数增长，直到超过慢启动阈值(ssthresh)则不再增长，后续则启动拥塞避免算法对窗口进行线性增长**。


## 8、TCP 链接的建立 - 三次握手


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f92247e0104?w=2162&h=1030&f=png&s=416096)


### 为什么发送方要发出第三个确认报文呢？

- 1）、**已经失效的连接请求报文传送到对方，引起错误：假设两次握手就可以，失效的链接请求报文就会被接收并建立了重复的连接。当使用三次握手时，比较慢到达接收方的报文也会发送一个确认给发送方，但是发送方已经进行了第三次握手了，因此发送方会忽略掉第二次的确认，不会进行任何的操作**。
- 2）、**因为信道不可靠，而 TCP 想在不可靠信道上建立可靠地传输，那么三次通信是理论上的最小值。（而 UDP 则不需建立可靠传输，因此 UDP 不需要三次握手）**
- 3）、**因为双方都需要确认对方收到了自己发送的序列号，确认过程最少要进行三次通信**。


## 9、TCP 链接的释放 - 四次挥手


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f95693115c6?w=2086&h=1034&f=png&s=552582)


### 1）、等待计时器 

- 会等待 2MSL 时间 => 4分钟。 
- 时间等待定时器是由是在四次挥手时由主动关闭 TCP 连接的一方设置的，它主要是为了 **保证主动关闭方在对最后一个 FIN 报文（第三次挥手）发送确认的报文可以到达接收方**。
- MSL(Max Segment Lifetime): 最长报文段寿命。MSL 建议设置为2分钟。


### 2）、为什么需要等待 2MSL？

- 1）、**因为最后一个报文没有确认，我们需要确保发送方的 ACK 可以达到接收方，如果 2MSL 时间内没有收到，则接收方会重发**。
- 2）、**2MSL 时间可以保证当发送方没有收到确认时，接收方可以再次发送 FIN 报文，并且接收方可以再次收到并重新发送确认，所以 2MSL 的时间可以保证连接正常结束**。
- 3）、**确保当前连接的所有报文都已经过期了**。


## 10、TCP 与UDP 的区别

- 1）、**UDP 通常用于多媒体信息分发，即视频、语音、实时信息 等等。而 TCP 通常用于可靠信息的传输，应用场景包括金融交易、可靠通信、MQ 等等**。
- 2）、**TCP 面向连接，UDP 是无连接的**。
- 3）、**TCP 提供可靠的服务，也就是说，通过 TCP 连接传送的数据，无差错，不丢失，不重复，且按序到达；UDP 尽最大努力交付，即不保证可靠交付**。
- 4）、**TCP 的逻辑通信信道是全双工的可靠信道；UDP 则是不可靠信道**。
- 5）、**每一条 TCP 连接只能是点到点的；UDP 支持一对一，一对多，多对一和多对多的交互通信**。
- 6）、**TCP 面向字节流（可能出现黏包问题），实际上是 TCP 把数据看成一连串无结构的字节流；UDP 是面向报文的（不会出现黏包问题）**。
- 7）、**UDP 没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如 IP 电话，实时视频会议等）**
- 8）、**TCP 首部开销20字节；UDP 的首部开销小，只有 8 个字节**。


## 11、套接字(Socket)

我们可以使用端口（Port）来标记不同的网络进程，而端口使用了16比特位表示(0~65535)。

### 1）、Socket 概念

- 套接字是一个抽象的概念，表示 TCP 连接的一端。
- 通过套接字可以进行数据的发送或接收。
- TCP = { Socket1:Socket2} = {{IP:Port}{IP:Port}}，可以看到，TCP 由两个套接字组成。


### 2）、Socket 编程

#### 服务端编程

- 1）、**创建 Socket**。
- 2）、**绑定 Socket**。
- 3）、**监听 Socket**。
- 4）、**接收 & 处理信息**。


其代码如下所示：


```python
import socket


def server():
    # 1、创建 Socket
    s = socket.socket()
    host = "127.0.0.1"
    port = 5678

    # 2、绑定 Socket
    s.bind(host, port)

    # 3、监听
    s.listen()

    # 4、发送数据
    while True:
        c, addr = s.accept()
        print("connect addr", addr)
        c.send(b'Socket Study.')
        c.close()
```


#### 客户端编程

- 1）、**创建 Socket**。
- 2）、**连接 Socket**。
- 3）、**发送消息**。


其代码如下所示：


```python
import socket


def client(i):
    # 1、创建 Socket
    s = socket.socket()

    # 2、连接 Socket
    s.connect(('127.0.0.1', 5678))

    # 3、接收消息
    print("Received message:%s, client Id:%d" % (s.recv(1024), i))
    s.close()


if __name__ == '__main__':
    for i in range(10):
        client(i)
```


单机通信更推荐使用域 Socket，相比网络通信数据需要在整个协议栈走一轮，域 Socket 它的处理流程更加简单，系统消耗更加小。此外，如果对 Socket IO 实现机制有兴趣的同学可以 [点击此处](https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md).


## 12、TCP 协议细节之 TCP 协议的四个定时器

- 1）、**超时定时器**
- 2）、**坚持定时器**
- 3）、**时间等待定时器**
- 4）、**保活定时器**：服务端一般都会设置一个保活定时器，它是为了保活 TCP 连接而设计的，可以防止 TCP 连接的两端出现长时间的空闲，当一方出现变化或故障时，另一方没有察觉的情况。
当服务端每次收到对方的数据则重置这个定时器，如果定时器超时，则会发送弹出报文段，以此探测客户端是否在线，如果没有收到响应的话，那么则认为客户端已经断开连接了，因此服务端也会终止这个链接。现如今，很多的分布式系统都会使用保活定时器来检测其它节点是否在线还是已经故障，或者其它节点也会每隔一段时间向主节点上报心跳信息以证明在线。


## 13、TCP 在三次握手的时候，IP 层和 MAC(Medium Access Control) 层在做什么呢？

其实 TCP 每发送一个消息，都会带着 IP 层和 MAC 层。因为 TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。

需要注意的是，**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。所以，对 TCP 来说，无论是三次握手还是重试，只要想包网络包发送出去，就要有 IP 层和 MAC 层，不然是发不出去的**。



# 八、网络层

## 1、网络层主要功能 

数据路由。

## 2、IP 协议

### 1）、IP 协议拆解

#### 虚拟互联网络

- 1）、实际的计算机网络是错综复杂的。
- 2）、物理设备通过使用 IP 协议，屏蔽了物理网络之间的差异。
- 3）、当网络中的主机使用 IP 协议连接时，则无需关注网络细节。


计算机 A 与 B 之间的数据通信可以认为是通过一个虚拟的互连网络进行传输的。


### IP 协议的作用

- 1）、IP 协议 **使得复杂的实际网络变为一个虚拟互连的网络**。
- 2）、IP 协议 **使得网络层可以屏蔽底层细节而专注网络层的数据转发**。
- 3）、IP 协议 **解决了在虚拟网络中数据报传输路径的问题**。


### IP 地址

**每一个唯一的网络设备都有一个唯一的 IP 地址。不同于 MAC 地址是不可改变的，IP 地址会根据当前设备所连接的网络环境的变化而发生变化**。

例如一个 IP 地址：192.168.11.11 => 11000000.10101000.00001011.00001011

#### 特点

- IP 地址长度为 32位，常分为4个8位。
- IP 地址常使用点分十进制来表示，即 0~255.0~255.0~255.0~255。
- IP 地址最多有 2 ^ 32 = 4294961296 => 42 亿。


IP 数据报 = IP 首部 + IP 数据报的数据，**IP 数据报的报文格式** 如下所示:


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f9a359e3d1e?w=1566&h=966&f=png&s=420056)


#### 版本

占4位，指的是 IP 协议的版本，通信双方的版本必须一致，当前主流版本是4，即 IPv4，也有 IPv6。


#### 首部位长度

占4位，最大数值为15，表示的是 IP 首部长度，单位是 32位字（4个字节）。所以 IP 首部的 **最大长度为 15 * 4 = 60字节**。


#### 服务类型（TOS）

表示当前的数据包是高优先级的，还是低优先级的。数据包是按照 TOS 被分配到3个波段（band0、band1、band2）里面的。


#### 总长度

占16位，最大数值为65535，表示的是 IP 数据报的总长度（IP 首部 + IP 数据）。


需要注意的是，**数据在数据链路层中的传输受最大传输单元 MTU 的限制，而 MTU 一般为为 1500 个字节，如果 IP 数据报的长度高于 MTU 的话，数据链路层将会把 IP 数据报进行
分片，即拆分成多个数据帧进行传输**。


#### 标识

协议内部自身使用，不需要关注。


#### 标志

占3位，目前只有两位是有意义的，**标识是否进行分片**。


#### 片偏移

占 13 位，**如果发生了分片，这里将会记录当前的数据帧保存的是第几个偏移的 IP 数据**。


#### TTL

- **占8位，表明 IP 数据报文在网络中的寿命,每经过一个设备，TTL 减1，当 TTL = 0时，网络设备必须丢弃该报文**。
- **当 IP 报文在网络中找不到终点的时候，避免 IP 数据在网络中无限进行传输，消耗带宽**。


#### 协议

占8位，**表明 IP 数据所携带的具体数据是什么协议的**。（例如：TCP、UPD 等等）


协议 | 值
---|---
ICMP | 1
IGMP | 2
IP | 4
TCP | 6
UDP | 17
OSPF | 89


#### 首部校验和

**占16位，校验 IP 首部是否有错，接收方在接收了 IP 数据报文之后会进行头部的校验，如果出错会进行丢弃**。

#### 源 IP 地址

发送 IP 数据报文的 IP 地址。

#### 目的 IP 地址

数据报到达的 IP 的地址。


### 2）、IP 协议的转发流程

#### 逐跳(hop-by-hop)

数据是从目的设备传输到下一个网络1，又从下一个网络1传输到路由器，又从路由器跳到下一个网络2，所以是一跳一跳，即 hop-by-hop。


#### 路由表

- 1）、**不同于 MAC 地址表是由一组一组的 MAC 地址与硬件接口组成的，路由表是由一组一组的 目的 IP 地址与 下一跳的 IP 地址组成的**。
- 2）、**计算机或者路由器都拥有路由表**。


#### 转发流程


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4f9d7cbc0feb?w=2058&h=664&f=png&s=151863)


- 1）、A 发出目的地为 C 的 IP 数据报，查询路由表发现下一跳为 E。
- 2）、A 将 IP 数据报交给数据链路层，并告知目的 MAC 地址是 E。
- 3）、数据链路层填充源 MAC 地址 A 和目的 MAC 地址 E。
- 4）、数据链路层通过物理层将数据发送给 E。
- 5）、E 的数据链路层接收到数据帧，把帧数据交给网络层。
- 6）、E 查询路由表，发现下一跳为 F。
- 7）、E 把数据报交给数据链路层，并告知目的 MAC 地址为 F。
- 8）、E 的数据链路层封装数据帧并发送。
- 9）、F 的数据链路层接收到数据帧，把帧数据交给网络层。
- 10）、F 查询路由表，发现下一跳为 C。
- 11）、F 把数据报交给数据链路层，并告知目的 MAC 地址为 C。
- 12）、F 的数据链路层封装数据帧并发送。


#### MAC 地址与 IP 地址最大的区别

- 1）、**数据帧每一跳的 MAC 地址都在变化，而IP 数据报每一跳的 IP 地址始终不变**。
- 2）、**IP 地址具有远程定位功能，而 MAC 地址更像是身份证号，它的唯一性是为了组网时可以不用担心不同的网卡在一个网络里会产生冲突，从硬件角度保证不同的网卡有不同的标识**。
- 3）、**相比于 IP 地址，MAC 地址的通信范围比较小，局限在一个子网里。例如：从 192.168.0.1/24 访问 192.168.0.9/24 是可以用 MAC 地址的**。


### 3）、IP 地址的子网划分

#### 为什么要对 IP 地址进行划分？

因为规划和分配 IP 地址非常麻烦。

#### 分类的 IP 地址

组成形式：网络号 + 主机号

通常有如下三种类型的 IP 地址：


- **A 类：首位为0，网络号为 8 位，主机号为24位**。
- **B 类：首位为10，网络号为 16 位，主机号为16位**。
- **C 类：首位为110，网络号为 24 位，主机号为8位**。


#### 展示图


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fa0328300b2?w=1916&h=962&f=png&s=272923)


#### 特殊的网络号

- **A 类地址网络段全0(00000000)表示特殊网络**。
- **A 类地址网络段后7位全1(01111111:127)表示回环地址**。
- **B 类地址网络段(10000000.00000000:128.0)是不可使用的**。
- **C 类地址网络段(192.0.0)是不可使用的**。


#### 特殊的主机号

- **主机号全0表示当前网络段，不可分配为特定主机。例如：1.0.0.0**。
- **主机号为全1表示广播地址，向当前网络段所有主机发消息。例如：0.1.11.111**。


#### 表格图


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fa357b9529e?w=2254&h=436&f=png&s=479719)


**本地回环地址(Loopback Address)：127.0.0.1，不属于任何一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远不会废弃的接口。在 Windwos 操作系统中也有相似的定义，所以一般在安装网卡前就可以 ping 通这个本地回环地址。一般都会用来检查本地网络协议、基本数据接口等是否是正常的**。代码如下所示：


```java
quchao@quchaodeMacBook-Pro EMC-MBANK-ANDROID % ping 127.0.0.1
PING 127.0.0.1 (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.068 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.103 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.081 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.081 ms
```


#### 分类地址的补充

- D 类地址：1110.....
- E 类地址：1111.....


它们都仅用作特殊用途。


#### 划分子网

> 某公司拥有256名员工，每人配备一个计算机，请问该公司应该申请哪种网络段？

分配 B 类地址，但是一个 B 类地址所能容纳的主机数量为 2^16-2，这会造成极大的浪费。为了解决这个问题，需要划分子网。

例如：将 193.10.10.0 这个 IP 划分为 193.10.10.0 ~ 193.10.10.127 与 193.10.10.128 ~ 193.10.10. 255。


> 子网这么多，如何判断某个 IP 的网络号？


#### 子网掩码

**快速地判断某一个 IP 属于哪一个子网号，通过 IP & 子网掩码 = 该 IP 对应的子网号**。子网掩码的组成特点如下所示：


- 1）、**与 IP 地址一样，都是32位**。
- 2）、**由连续的1和连续的0组成**。
- 3）、**某一个子网的子网掩码具备网络号位数个连续的1**。


例如 A、B、C 类的子网掩码地址：A类：255.0.0.0，B类：255.255.0.0，C类：255.255.255.0


#### 无分类编址 CIDR

- 1）、**CIDR 中没有 A、B、C 类网络号 和 子网划分的概念**。
- 2）、**CIDR 将 网络前缀 相同的 IP 地址称为一个 CIDR 地址块**。
- 3）、**网络前缀是任意位数的**。
- 4）、**相比原来子网划分更加灵活**。


**CIDR 使用了斜线记法，例如：193.10.10.129/25 表示网络号为 25 位，主机号为 7位**。一般家里都是使用 /24 的 CIDR，此时整个网络里面的第一个地址为 192.168.0.1，往往就是私网的出口地址。例如：家里面的电脑连接 WIFI，WIFI 路由器的地址就是 192.168.0.1，而 192.168.0.255 就是广播地址。


> loopback 是什么？

**即环回接口，通常会被分配到 127.0.0.1 这个地址，它用于本机内部通信，经过内核处理后直接返回，不会再任何网络中出现**。


> 某公司总共有 200 名员工，需要拆分成两个部分，每个部分使用一个小型网络，如何使用 CIDR 进行划分？

可以使用一个 /24 作为一个中型网络（在 CIDR 中被称为超网），旗下有两个 /25 作为一个小型网络（在 CIDR 中被称为子网）。


## 3、ARP 协议与 RARP 协议

> 在 IP 数据的转发过程中，A 将 IP 数据报交给数据链路层，并告知其目的 MAC 地址是 E。这里 A 是如何知道目的 MAC 地址是 E 的呢？


### 1）、ARP(Address Resolution Protocol)地址解析协议

**ARP 协议将网络层 IP 32位地址转换为数据链路层 MAC 48位地址**。

#### ARP 缓存池表

**缓存了 IP 地址到硬件地址之间的映射关系。有缓存时直接从缓存中取出即可，没有缓存时则会和 MAC 地址表获取地址时使用的广播形式类似**，即

- 1）、**E 检查 MAC 地址表，发现没有 C 的信息**。
- 2）、**E 将广播 A 的数据包到除 A 以外的端口**。
- 3）、**E 将收到来自 B、C 的回应，并将地址记录**。


**ARP 缓存是 ARP 协议和 RARP 协议运行的关键。此外，ARP 缓存表中的记录并不是永久有效的，有一定的期限**。


#### 查看 ARP 缓存表

使用 `arp -a` 命令，如下所示：

```java
quchao@quchaodeMacBook-Pro EMC-MBANK-ANDROID % arp -a
? (22.1.253.254) at 0:10:db:ff:10:0 on en0 ifscope [ethernet]
? (224.0.0.251) at 1:0:5e:0:0:fb on en0 ifscope permanent [ethernet]
? (239.255.255.250) at 1:0:5e:7f:ff:fa on en0 ifscope permanent [ethernet]
```


#### ARP 协议

**ARP 协议被直接封装在了数据链路层中的数据帧里面的**。

> 既然 ARP 协议是直接被封装在数据链路层中的数据帧里面的，那么为什么它是属于网络层的内容？


主要是因为 **ARP 协议使用到了网络层的 IP 地址**。

#### ARP 协议内容


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fa97c6c5d8a?w=1958&h=816&f=png&s=465112)


### 2）、RARP(Reverse Address Resolutioni Protocol)逆地址解析协议

- 1）、**将数据链路层 MAC 48位地址转换为网络层 IP 32位地址**。
- 2）、**除了类型 8035 标识为 RARP 协议，其它内容与 ARP 协议类似**。


### 3）、小结

- RARP 协议与 ARP 协议是 TCP/IP 协议栈里面的基础协议，它们的操作对程序员是透明的。
- 理解它们有助于我们理解网络分层的细节。
- **它们是协调数据链路层和网络层配合工作的重要协议**。


## 4、网络地址转换 NAT(Network Address Translationn) 技术

**不改变 IP 地址的网关，我们称为转发网关；改变 IP 地址的网关，我们称为 NAT 网关**。

> 为什么要使用 NAT？


- 1）、**IPv4 最多只有40+亿个 IP 地址**。
- 2）、**早期 IP 地址的不合理规划导致 IP 号浪费**。


### 1）、内网地址

#### 特点

- 1）、内部机构使用。
- 2）、避免与外网地址重复。

#### 三类内网地址

- **A 类：10.0.0.0~10.255.255.255（支持千万数量级设备）**。
- **B 类：172.16.0.0~172.31.255.255（支持百万数据级设备）**。
- **C 类：192.168.0.0~192.168.255.255（支持万数量级设备）**。


对于公司，它可以在外部使用全球唯一的外网 IP 地址，通常在内部使用一个 B 类内网地址即可。

同理，对于家庭可以在外部使用全球唯一的外网 IP 地址，通常在内部使用一个 C 类内网地址即可。


> 问题：内网的多个设备使用同一个外网 IP 请求外网服务，外部是怎么样才能知道是哪一个内网设备请求的呢？

**使用 NAT ，它用于多个主机通过一个公有 IP 访问互联网的私有网络，并减缓了 IP 地址的消耗，但是增加了网络通信的复杂度**。


### 2）、外网地址

- 全球范围使用。
- 全球公网唯一。


### 3）、端口映射

例如如下两个 NAT 转换过程：发送数据时，A 设备内网地址和端口号 => 外网地址与端口号：192.168.2.11:6666 => 173.21.59.10:16666，B 设备内网地址和端口号 => 外网地址与端口号：192.168.2.10:7777 => 173.21.59.10:17777。

**由于同时转换了 Port ，即进行了 端口映射，NAT 也可称为 NA(P)T**。


## 5、ICMP(Internet Control Message Protocol)协议

### 1）、ICMP 协议拆解

#### 功能

ICMP 协议主要是用于 **辅助 IP 协议发送与接收数据的，它可以报告错误信息或异常情况**。


#### ICMP 报文结构

**ICMP 协议被封装在 IP 数据报的数据之中，其也分为 报文首部与报文数据。如果需要使用 ICMP 协议，则需要在 IP 协议首部的8位协议中写入1，以表明 IP 数据所携带的具体数据是 ICMP 协议的**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4facf6e202e5?w=1614&h=250&f=png&s=126103)


#### 类型

#### 1、差错报告报文

差错报告报文具体分为 **七种类型**，而 **大部分的报文类型是由类型的值和具体代码组成的**。具体如下图所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fb0f7c6de40?w=1620&h=620&f=png&s=418330)


#### 2、询问报文

询问报文具体分为 **两类**，它仅仅是由 **类型的值** 决定的。具体如下图所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fb32129f0b1?w=1578&h=414&f=png&s=292797)


常用的 ping 就是查询报文，是一种主动请求并且获得主动应答的 ICMP 查询报文，如下：

- `ICMP ECHO REQUESTZ`：**对 ping 的主动请求进行网络抓包**。
- `ICMP ECHO REPLY`：**主动请求的回复**。


所以，ping 发的包也是符合 ICMP 格式的，仅仅增加了一些自己的格式。如下所示：

- 1）、**标识符：派出去两队侦察兵，一队是侦查战况的，一队是去查找水源的，要有个标识才能区分**。
- 2）、**序号：派出去的侦察兵，都要进行编号，便于知道前线的战况**。
- 3）、**发送请求时间值：存放在选项数据中，用来计算往返时间和路程的长短**。


ping 命令执行时，源主机会构建一个 ICMP 请求数据包，其中有两个最重要的字段，如下：

- 1）、**类型：对于请求数据包，此值为8**。
- 2）、**顺序号：区分连续 ping 时发出的多个请求数据包。每发出一个请求数据包，顺序号会自动加1**。


### 2）、ICMP 报文的应用

#### Ping 应用

例如 ping www.wanandorid.com 网站，如下所示：

```java
quchao@quchaodeMacBook-Pro cmmp-core-client-android % ping www.wanandroid.com
PING www.wanandroid.com (47.104.74.169): 56 data bytes
64 bytes from 47.104.74.169: icmp_seq=0 ttl=51 time=51.877 ms
64 bytes from 47.104.74.169: icmp_seq=1 ttl=51 time=52.416 ms
64 bytes from 47.104.74.169: icmp_seq=2 ttl=51 time=48.942 ms
64 bytes from 47.104.74.169: icmp_seq=3 ttl=51 time=45.816 ms
64 bytes from 47.104.74.169: icmp_seq=4 ttl=51 time=48.336 ms
64 bytes from 47.104.74.169: icmp_seq=5 ttl=51 time=42.358 ms
ç64 bytes from 47.104.74.169: icmp_seq=6 ttl=51 time=49.428 ms
64 bytes from 47.104.74.169: icmp_seq=7 ttl=51 time=41.963 ms
```


#### 使用 Ping 命令对网络故障进行排查

遇到网络不通的问题时，除了直接 ping 目标 IP 地址，头脑中年还应该有一个清晰的网络拓扑图，并且需要清楚地知道一个包从源地址传到目标地址要经过哪些设备，然后逐个 ping 中间的这些设备或机器，通常的排查步骤如下所示：

- 1）、**ping 回环地址 127.0.0.1，不通，说明计算机使用的协议栈有问题，需要重装系统或协议栈**。
- 2）、**Ping 网关地址（路由地址），内网 ping 192.168.0.1/ 192.168.1.1，通，说明本机到路由器的地址是通的。不通，则说明 WIFI、网线是有问题的**。
- 3）、**Ping 远端地址 ping www.wanandroid.com，不通，则说明家中到 ISP 的网络之间是有故障的。这个时候就要从电信、联通、移动等 ISP 来排查问题了**。


此外，除了 ping 之外，我们还可以通过 `tcpdump -i eth0 icmp`，**查看发出的包有没有到达某个点，以及回复的包到达了哪个点，以便更容易推断出错的位置**。


> ping 不同一定就代表网络不通吗？

不是，如果不在我们的控制范围内，很多中间设备都是禁止 ping 的，但是 ping 不通不代表网络不通。这个时候就要使用 Telnet，通过其他协议来测试网络是否畅通。


#### Traceoute 应用

**用于探测 IP 数据报在网络中走过的路径**。

在 IP 数据报的首部中，有一个8位的生存时间 TTL，它表示了 IP 数据报文在网络中的寿命，每经过一个设备，TTL 减1，**当 TTL = 0时，网络设备必须丢弃该报文，并会发送 ICMP 终点不可达差错报文**。

而 Traceoute 则巧妙地应用了 ICMP 终点不可达差错报文与 TTL 机制，为了探测 IP 数据报文走过的路径，它会发送一个 UDP 数据包。将 TTL 设置为1，一旦遇到一个路由器，它就会牺牲了。接着返回一个 ICMP 包，就是网络差错包，类型是时间超时，这样就能知道一个路由器有多远。具体机制如下所示：

- 1）、**首先，会封装一个 TTL 为1的数据报文，当到达第一个网络之后，TTL 会减为0，第一个网络会发现 TTL 减为0了，此时就会往源主机发送 ICMP 终点不可达的差错报文。这个时候源主机就会把第一个网络的 IP 地址记录下来**。
- 2）、**然后，会封装一个 TTL 为2的数据报文，当到达第二个网络之后，TTL 会减为0，第二个网络会发现 TTL 减为0了，此时就会往源主机发送 ICMP 终点不可达的差错报文。这个时候源主机就会把第二个网络的 IP 地址记录下来**。
- 3）、**后面按 TTL + 1，到达的网络次序 + 1的规律进行，直到到达目的主机，最后得到目的主机的 IP 地址**。


这样，源主机就接收到了所有的路径信息，就可以输出该数据报在网络中的路径了。traceroute 命令的使用示例如下所示：

```java
tracert github.com (Windows 为 tracert github.com)
quchao@quchaodeMacBook-Pro cmmp-core-client-android % traceroute github.com
traceroute to github.com (13.250.177.223), 64 hops max, 52 byte packets
1  22.4.93.254 (22.4.93.254)  11.676 ms  7.331 ms  9.620 ms
2  59.40.180.129 (59.40.180.129)  977.679 ms  440.943 ms  10.672 ms
3  49.186.37.59.broad.dg.gd.dynamic.163data.com.cn (59.37.186.49)  9.207 ms  12.436 ms  10.636 ms
4  125.176.37.59.broad.dg.gd.dynamic.163data.com.cn (59.37.176.125)  13.202 ms  10.292 ms  28.478 ms
5  183.56.65.6 (183.56.65.6)  11.763 ms  9.236 ms
183.56.65.18 (183.56.65.18)  11.392 ms
6  202.97.94.134 (202.97.94.134)  18.357 ms
202.97.94.150 (202.97.94.150)  18.175 ms
202.97.94.134 (202.97.94.134)  36.600 ms
7  202.97.94.98 (202.97.94.98)  245.161 ms
202.97.12.29 (202.97.12.29)  19.504 ms
202.97.12.41 (202.97.12.41)  22.256 ms
```


> 为什么查找一个 IP 地址时可能会看不到中间有些路由器的信息？

因为有的路由器根本不会返回这个 ICMP 包。


## 6、路由

### 1）、路由简介

路由表包括了 **目的 IP 地址与下一跳 IP 地址的映射关系**。

#### 自治系统（Autonomous System）

- 一个自治系统 AS 是处于一个管理机构下的网络设备群。
- AS 内部网络自行管理，并提供一个或多个出入口。


**从网络的分级层级来看，每一个主干 ISP 都可以认为是一个主干 AS，每一个地区 ISP 都可以认为是一个地区 AS，而每一个公司、校园、家庭都可以认为是一个小的 AS**。


### 2）、路由协议

- 自治系统内部路由的协议：内部网关协议（RIP、OSP）
- 自治系统外部路由的协议：外部网关协议（BGP）


例如家庭 AS1 与公司 AS2 它们直接使用的网关协议示意图如下所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fb6897bcd7a?w=1838&h=310&f=png&s=121179)


我们可以把网络拓扑图转换为图，其中

- **每一个顶点表示一个网络、路由器或计算机**。
- **每一条边表示一条网络路径**。


**路由算法的本质即图论的算法，但由于复杂的网络环境，所以路由算法比图论算法要更加复杂**。


> 如何设计一个好的路由算法？

- 1）、正确、完整：算法是正确与完整的。
- 2）、计算简单：算法在计算上应该尽可能地简单。
- 3）、适应变化：算法可以适应网络中的各种变化。
- 4）、稳定、公平：算法是稳定与公布的。


#### 1、内部网关路由协议之 RIP(Routing Information Protocol) 协议

##### 距离矢量（DV）算法

- 1）、**每一个节点使用两个向量 Di 和 Si**。
- 2）、**Di 描述的是当前节点到别的节点的距离**。
- 3）、**Si 描述的是当前节点到别的节点的下一节点**。
- 4）、**首先，每一个节点会与相邻的节点交换向量 Di 和 Si 的信息**。
- 5）、**每一个节点根据交换的信息更新自己的节点信息：首先运算，然后把当前计算的结果和距离矢量进行比较，如果距离更小的话，则更新自己的距离矢量**。


##### RIP 协议的特点

- 1）、**RIP 协议是使用 DV 算法的一种路由协议**。
- 2）、**把网络条数(hop)作为 DV 算法的距离**。
- 3）、**RIP 协议每隔30s交换一次路由信息**。
- 4）、**RIP 协议认为跳数 > 15 的路由则为不可达路由**。


##### RIP 协议的过程

- 1、**路由器初始化路由信息（两个向量 Di 和 Si）**。
- 2、**对相邻路由器 X 发过来的信息，对信息的内容进行修改**。
    - 1）、**检索本地路由，将信息中新的路由插入到路由表里面**。
    - 2）、**检索本地路由，对于下一跳为 X 的，更新为修改后的信息**。
    - 3）、**检索本地路由，对比相同目的的距离，如果新信息的距离更小，则更新路由表**。
- 3、**如果3分钟没有收到相邻的路由信息，则把相邻路由设置为不可达（16跳）**。


##### RIP 协议的优势

**实现简单，开销很小**。


##### RIP 协议的弊端

假设有一个 A-B-C 的链路，假如 A 路由节点出现问题无法使用，那么 B、C 就会互相询问，知道它们各自的跳数一直累加到超过 15 跳。

- 1）、**随便相信相邻节点**。
- 2）、**自己不思考，视野局限，导致故障信息传递慢**。
- 3）、**限制了网络的规模，只能在较小的网络中使用，因为它把跳数大于15的认为不可达**。


#### 2、内部网关路由协议之 OSPF 协议

##### 链路状态（LS）协议

与 RIP 协议的不同：

- 1）、**向所有的路由器发送消息**。
- 2）、**消息描述该路由器与相邻路由器的链路状态**。
- 3）、**只有链路状态发送变化时，才发送更新消息**。


因此，可以看到 **LS 协议解决了 RIP 协议 随便相信隔壁路由、视野不够的问题**。


##### Dijkstra 算法

特点：


- 1）、**Dijistra 算法是著名的图算法，它解决的是计算最短路径的问题**。
- 2）、**解决有权图从一个节点到其它节点的最短路径问题**。
- 3）、**以起始点为中心，向外层层扩展**。


过程：

- 1、**初始化两个集合（S，U）（S 为只有初始顶点点 A 的集合，U 为其它顶点集合）**。
- 2、**如果 U 不为空，对 U 集合顶点进行距离的排序，并取出距离 A 最近的一个顶点 D**：
    - 1）、**将顶点 D 纳入 S 集合**。
    - 2）、**更新通过顶点 D 到达 U 集合所有点的距离（如果距离更小则更新，否则不更新）**。
    - 3）、**重复2步骤**。
- 3、**直到 U 集合为空，算法完成**。


##### OSPF(Open Shortest Path First) 开放最短路径优先协议的过程

核心是 Dijkstra 算法。

- 1）、**向所有的路由器发送消息，因此每一个路由器都可以获得网络中的所有信息，并因此得到完整的网络拓扑（链路状态数据库）。而且，每一个路由器都可以使用 Dijikstra 算法找到自己到达某一个顶点的最短路径**。
- 2）、**消息描述该路由器与相邻路由器的链路状态（即距离、时延、带宽），因此 OSPF 协议比 RIP 协议更加客观与先进**。
- 3）、**只有链路状态发生变化时，才发送更新信息，这使得路由器减少了数据的交换，能够更快地收敛**。


然后，我们再来回顾一下 **完整过程**：

- 首先，**路由器接入网络**。
- 然后，**路由器向邻居发出问候信息，以此来确认可达性**。
- 确认后，**就会与邻居交流链路状态数据库，并将链路状态数据库都同步为最新的**。
- 最后，**路由器会广播和更新未知路由**。


##### 五种消息类型

- 1）、**问候消息（Hello）：测试自身与相邻路由器的可达性**。
- 2）**、链路状态数据库描述信息：用于向隔壁路由器发送自己的链路状态的一些简单的描述信息**。
- 3）、**链路状态请求信息：用于向隔壁路由器请求链路状态数据**。
- 4）、**链路状态更新信息：使用最频繁也是最重要的信息**。
- 5）、**链路状态确认信息：用于对链路更新的一个确认**。


##### RIP 协议 与 OSPF 协议的对比


RIP | OSPF
---|---
从邻居看网络 | 整个网络的拓扑
在路由器之间累加距离 | Dijkstra 算法计算最短路径
频繁、周期更新，收敛很慢 | 状态变化更新，收敛很快
路由间拷贝路由信息 | 路由间传递链路状态，自行计算路径


##### OSPF 的缺点

虽然 OSPF 协议解决了 RIP 协议的问题，对整个网络有了一定的全局观，但是 **OSPF 协议本身较为复杂，实现开销较大**。


#### 3）、外部网关路由协议之 BGP(Border Gateway protocol) 边际网关协议（很复杂、了解即可）

- BGP 协议是运行在 AS（自治系统）之间的一种协议。
- BGP 协议是因为计算机网络中人为因素的复杂性而提出的，在实际的网络环境中，数据的传输还受整治、安全等因素的影响。


> 为什么要在 AS 之间使用 BGP 协议呢？

- 1）、**互联网的规模很大，这使得在 AS 之间选择路由非常困难，如果我们在 AS 之间选择链路状态协议，每个路由器都需要存储很多链路状态的数据，并且如果使用 Dijikstra 算法，运行会很慢，因此需要使用 BGP 协议**。
- 2）、**AS 内部使用不同的路由协议，例如在一个 AS 中使用了 RIP 协议，而另一个 AS 中则使用了 OSPF 协议。对于使用不同的协议的路由器，在它们之间是无法通信的，因此它们之间便需要借助 BGP 协议来进行协调**。
- 3）、**AS 之间需要考虑除网络特性之外的一些因素，例如 政治、安全**。


**由于各个 AS （国家、地区）之间政策、安全等原因，BGP 仅能够找到一个到底目的地的比较好的路由。而 AS 之间是通过 BGP 发言人来进行路由信息的交换的**。


# 九、数据链路层

## 1、主要功能

### 1）、封装成帧

> 什么是数据帧？

- **帧是数据链路层数据的基本单位**。
- **发送端在网络层的一段数据前后添加特定标记形成帧**。
- **接收端根据前后特定标记识别出帧**。


#### 数据帧结构

- **网络层将 IP 数据报 传送到 数据链路层时，在数据链路层会给 IP 数据报 的前后添加 帧首部与帧尾部**。
- **帧首部与尾部都是特定的控制字符，即一些特定的比特流，例如帧首部的 SOH:00000001，帧尾部的EOT:00000100**。


> 如果数据里面刚好有这些比特流怎么办？


### 2）、透明传输

> 透明传输是什么？


- 1）、**计算机领域中非常重要的一个术语。例如对于数据链路层来说，物理层所做的工作就是透明的，物理层只需向外暴露接口即可**。
- 2）、**一种实际存在的事物但是看起来像不存在一样**。
- 3）、**即使控制字符在帧数据中，但是要当做不存在一样去处理**。


#### 透明传输的应用

> 如果数据里面刚好有这些控制字符该怎么办？

在该控制字符前面加上一个 ESC 转义字符，如果数据中也包含有 ESC 转义字符时，则可以在前面再加一个 ESC 转义字符。而数据链路层的转义字符可以类比与编程语言中的转义字符。


### 3）、差错监测

> 为什么要进行差错监测？


**因此物理层只管传输比特流，无法控制是否出错。所以数据链路层需要负责 差错监测 的工作**。

#### 差错监测的方式

##### 1、奇偶校验码

**在比特流的后面加上 奇偶校验码（1/0）.例如：00110100 => 所有位数和为3，是基数，在该比特流后面加1。（偶数加0）**

它的局限性在于 **当比特流中出错两位时，无法检测出错误**。


##### 2、CRC（循环冗余校验码）

- 1）、**一种根据传输或保存的数据而产生固定位数校验码的方式**。
- 2）、**检测数据传输或保存后可能出现的错误**。
- 3）、**生成的数字计算出来并且附加到数据后面**。


CRC 使用了 **模 2 除法**，即：**当最高位为0时，则认为余数不够除，取商为0**。


**发送端增加校验码：**

- 1）、**选定一个用于校验的多项式 G(x)（例如：CRC-7、CRC-8 就代表 G(x) 中最高位为8），并在数据尾部添加 r 个0**。
- 2）、**将添加 r 个0后的数据，使用模 2 除法除以多项式的位串**。
- 3）、**将得到的余数填充在原数据 r 个0的位置得到可校验的位串**。


**接收端验证校验码：**

- **接收数据除以 G(x) 的位串，如果余数为0，则校验成功**。


**缺点**

- 1）、**位串的阶数 r 越大，CRC 的错误检测能力越强。（阶数为1时，退化为奇偶校验码）**
- 2）、**数据链路层只进行数据的检测，不进行纠正，如果检测出错误数据会把该数据丢弃**。


## 2、最大传输单元 MTU（Maximum Transmission Unit）

### 1）、MTU

> 为什么要设计出 MTU？

数据帧过大或过小都会影响传输的效率。例如会增加数据传输时的总时延。以太网 MTU 一般为 1500 字节。


### 2）、路径 MTU

由传输链路中所有 MTU 中的最小 MTU 决定。


## 3、以太网协议

### 1）、MAC 地址（物理地址、硬件地址）

#### 特点

- 每一个设备都拥有唯一的 MAC 地址。
- MAC 地址共 48 位，使用十六进制表示。例如：30-B4-9E-ED-85-DA 。


#### 查看计算机的 MAC 地址

- MAC：ifconfig
- Windows：ipconfig /all


#### MAC 地址表

**存有 MAC 地址和硬件接口的映射关系。其中每一个 MAC 地址都有与之对应的硬件接口**。


### 2）、协议内容


#### 特点

- 一种使用广为使用的局域网技术。
- 一种应用于数据链路层的协议。
- 借助其可以完成相邻设备间的数据帧传输。


#### 数据格式

单位为 **字节**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fb9d86f04a5?w=1962&h=266&f=png&s=109716)


> 其中的帧数据具体是什么数据？


- **如果是网络层的 IP 数据，则 类型为 0800，帧数据 = IP 数据报**。
- **如果是 ARP 请求/应答，则 类型为 0806，帧数据 = ARP 请求/应答（28字节） + PAD（18字节）**。
- **如果是 RARP 请求/应答，则 类型为 8035，帧数据 = RARP 请求/应答（28字节） + PAD（18字节）**


#### 数据传输过程

- 1）、**设备 A 通过网卡发出数据帧**。
- 2）、**数据帧到达路由器，路由器取出前6字节，即目的设备 B 的 MAC 地址**。
- 3）、**路由器匹配 MAC 地址表，找到目的设备 B 的网络接口**。
- 4）、**路由器往该网络接口发送数据帧**。


> 如果 MAC 地址并不知道 B 的硬件接口，路由器如何处理？


- 1）、E 检查 MAC 地址表，发现没有 C 的信息。
- 2）、E 将广播 A 的数据包到除 A 以外的端口。
- 3）、E 将收到来自 B、C 的回应，并将地址记录。


# 十、物理层

## 1、作用

- 1）、**连接不同的物理设备**
- 2）、**传输比特流**


> 什么是比特流？

**由高低电频表示的数据流，1 => 高电频，0 => 低电频**，例如由比特流 100110101010 转化成的数字信号如下图所示：


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fbd2a8133f4?w=1622&h=358&f=png&s=69467)


## 2、常见的传输介质

### 1）、有线介质

#### 1、双绞线

##### 无屏蔽双绞线

从外至内由 **聚氯乙烯套层、绝缘层、铜线** 组成。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fc2bb7089aa?w=698&h=328&f=png&s=89324)


##### 双绞线

不同于 无屏蔽双绞线，其在第二层 **加了屏蔽层**。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fc6528e8604?w=670&h=314&f=png&s=109884)


#### 2、同轴电缆

从外至内由 **绝缘保护套层、外导体屏蔽层、绝缘层、内导体** 组成。


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fcdb8f650ff?w=1330&h=378&f=png&s=193991)


#### 3、光纤

光纤由 **包层（低折射率的媒体）、纤芯（高折射率的媒体）** 组成。


### 2）、无线介质

- 1）、红外线
- 2）、无线（例如 4G、WIFI）
- 3）、激光


## 3、信道基本概念

- 信道是往一个方向传送信息的媒体。
- 一条通信电路包含一个接受信道和一个发送信道。


> 如何处理发送与接受出现冲突的情况？

### 信道的分类

- 1）、**单工信道：只能往一个方向通信，没有反方向反馈的信息。例如 有线电视、无线电收音机等等**。
- 2）、**半双工信道：双方都可以发送和接受信息。不能双方同时发送，也不能同时接受**。
- 3）、**全双工信道：双方都可以同时发送和接收信息。例如网线、网络等等**。


## 4、分用与复用


![](https://user-gold-cdn.xitu.io/2020/5/5/171e4fd57a3c35bb?w=1524&h=690&f=png&s=129644)


### 复用的分类

- 1）、频分复用
- 2）、时分复用
- 3）、波分复用
- 4）、码分复用


## 十一、总结

计算机网络是一个需要我们持续深入探索的一门基础学科，在本篇中我们全面了解了计算机网络的核心基础知识，这为我们之后探讨移动网络优化相关的问题打下了一定的网络基础。网络优化之旅才刚刚开始~


> 关于计算机网络的高频问题可以 [查看此处](https://juejin.im/post/5e5b50eb6fb9a07cae136773#heading-3)。


# 参考链接：
---

- 1、慕课网之《编程必备基础 计算机组成原理+操作系统+计算机网络》网络部分 9 - 13章 
- 2、《趣谈网络协议》1 - 5章
- 3、《计算机网络 自顶向下方法》前 6 章
- 4、[(建议精读)HTTP灵魂之问，巩固你的 HTTP 知识体系](https://juejin.im/post/5e76bd516fb9a07cce750746)
- 5、[(建议收藏)TCP协议灵魂之问，巩固你的网路底层基础](https://juejin.im/post/5e527c58e51d4526c654bf41)
- 6、[一位前端小姐姐的五万字面试宝典](https://juejin.im/post/5e91b01651882573716a9b23#heading-90)
- 7、[面试带你飞：这是一份全面的 计算机网络基础 总结攻略](https://juejin.im/post/5ad7e6c35188252ebd06acfa#heading-2)
- 8、[JavaGuide - 网络](https://github.com/Snailclimb/JavaGuide#%E7%BD%91%E7%BB%9C)
- 9、[interview - 网络](https://github.com/huihut/interview#%EF%B8%8F-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C)
- 10、[总结了17年初到18年初百场前端面试的面试经验(含答案)](https://juejin.im/post/5b44a485e51d4519945fb6b7#heading-38)
- 11、[CS-Notes - 网络](https://github.com/CyC2018/CS-Notes#cloud-%E7%BD%91%E7%BB%9C)


# Contanct Me

##  ●  微信：

> 欢迎关注我的微信：`bcce5360`  

##  ●  微信群：

> **由于微信群已超过 200 人，麻烦大家想进微信群的朋友们，加我微信拉你进群。**
        

##  ●  QQ群：

> 2千人QQ群，**Awesome-Android学习交流群，QQ群号：959936182**， 欢迎大家加入~


## About me

- ### Email: [chao.qu521@gmail.com]()
- ### Blog: [https://jsonchao.github.io/](https://jsonchao.github.io/)
- ### 掘金: [https://juejin.im/user/5a3ba9375188252bca050ade](https://juejin.im/user/5a3ba9375188252bca050ade)
    

### 很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。

### 希望我们能成为朋友，在 [Github](https://github.com/JsonChao)、[掘金](https://juejin.im/user/5a3ba9375188252bca050ade)上一起分享知识。

















